/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/


process {

    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: params.publish_dir_mode,
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]


    withName: 'COLLECT_METADATA|PIXELATOR_*' {
        ext.singularity_pull_docker_container =  true

        // Use this to override all usages of the pixelator container
        // container = { get_pixelator_container(params) }
    }

    withName: COLLECT_METADATA {
        publishDir = [
            path: { "${params.outdir}/pipeline_info" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: "PIXELATOR.*" {
        publishDir = [
            [
                path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
                mode: "${params.publish_dir_mode}",
                saveAs: { filename -> (filename.endsWith('.log') || filename.equals('versions.yml')) ? null : filename }
            ],
            [
                path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}/logs" },
                mode: params.publish_dir_mode,
                pattern: "*.log"
            ]
        ]
    }

    withName: RENAME_READS {
        publishDir = [
            enabled: false,
            path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        ]
    }


    // use explicit params.my_option != null checks to avoid issues with 0 evaluating false
    // some pixelator flags do accept zero as a value

    withName: PIXELATOR_CONCATENATE {
        ext.args = {
            [
                "--design ${meta.design}",
            ].join(' ').trim()
        }
    }

    withName: PIXELATOR_QC {
        // Options for pixelator preqc
        ext.args = {
            [
                "--design ${meta.design}",
                (params.trim_front != null)? "--trim-front ${params.trim_front}": '',
                (params.trim_tail != null) ? "--trim-tail ${params.trim_tail}": '',
                (params.max_length != null) ? "--max-length ${params.max_length}": '',
                (params.min_length != null) ? "--min-length ${params.min_length}": '',
                (params.max_n_bases != null) ? "--max-n-bases ${params.max_n_bases}": '',
                (params.avg_qual != null)? "--avg-qual ${params.avg_qual}": '',
                params.dedup ? "--dedup": '',
                params.remove_polyg ? "--remove_polyg": '',
            ].join(' ').trim()
        }

        // Options for pixelator adapterqc
        ext.args2 = { [
                "--design ${meta.design}",
                params.adapterqc_mismatches ? "--mismatches ${params.adapterqc_mismatches}": '',
                (params.pbs1 != null)? "--pbs1 ${params.pbs1}": '',
                (params.pbs2 != null) ? "--pbs2 ${params.pbs2}": '',
            ].join(' ').trim()
        }
    }

    withName: PIXELATOR_DEMUX {
        ext.args = {
            [
                "--design ${meta.design}",
                (params.demux_mismatches != null) ? "--mismatches ${params.demux_mismatches}": '',
                (params.demux_min_length != null) ? "--mismatches ${params.demux_min_length}": '',
                (params.anchored != null) ? "--anchored ${params.anchored}": '',
                (params.rev_complement != null) ? "--rev-complement ${params.rev_complement}": '',
            ].join(' ').trim()
        }
    }

    withName: PIXELATOR_COLLAPSE {
        ext.args = [
            params.markers_ignore ? "--markers_ignore ${markers_ignore}":
            params.algorithm ? "--algorithm ${params.algorithm}": '',
            params.upia_start ? "--upi1-start  ${params.upia_start}": '',
            params.upia_end ? "--upi1-end  ${params.upia_end}": '',
            params.upib_start ? "--upi2-start  ${params.upib_start}": '',
            params.upib_end ? "--upi2-end  ${params.upib_end}": '',
            params.umia_start ? "--umi1-start  ${params.umia_start}": '',
            params.umia_end ? "--umi1-end  ${params.umia_end}": '',
            params.umib_start ? "--umi2-start  ${params.umib_start}": '',
            params.umib_end ? "--umi2-end  ${params.umib_end}": '',
            params.neighbours ? "--neighbours ${params.neighbours}": '',
            params.collapse_mismatches ? "--mismatches ${params.collapse_mismatches}": '',
            params.collapse_min_count ? "--min-count ${params.collapse_min_count}": '',
            params.use_counts ? "--use-counts": '',
        ].join(' ').trim()
    }

    withName: PIXELATOR_GRAPH {
        ext.args = [
            params.multiplet_recovery ? "--multiplet-recovery" : '',
            params.leiden_iterations ? "--leiden-iterations ${params.leiden_iterations}" : '',
            params.cluster_min_count ? "--min-count ${params.cluster_min_count}" : '',
        ].join(' ').trim()
    }

    withName: PIXELATOR_ANNOTATE {
        ext.args = [
            (params.min_size != null) ? "--min-size ${params.min_size}" : '',
            (params.max_size != null) ? "--max-size ${params.max_size}" : '',
            params.dynamic_filter ? "--dynamic-filter ${params.dynamic_filter}" : '',
            params.cell_type_assignments ? "--cell-type-assignments" : '',
            params.majority_vote ? "--majority-vote" : '',
            params.aggregate_calling ? "--aggregate-calling" : '',
        ].join(' ').trim()
    }

    withName: PIXELATOR_ANALYSIS {
        ext.when = { !params.skip_analysis }
        ext.args = [
            params.compute_polarization ? "--compute-polarization" : '',
            params.compute_colocalization ? "--compute-colocalization" : '',
            params.use_full_bipartite ? "--use-full-bipartite " : '',
            params.polarization_normalization ? "--polarization-normalization ${params.polarization_normalization}" : '',
            params.polarization_binarization ? "--polarization-binarization" : '',
            params.colocalization_transformation ? "--colocalization-transformation ${params.colocalization_transformation}" : '',
            (params.colocalization_neighbourhood_size != null) ? "--colocalization-neighbourhood-size ${params.colocalization_neighbourhood_size}" : '',
            (params.colocalization_n_permutations != null) ? "--colocalization-n-permutations ${params.colocalization_n_permutations}" : '',
            (params.colocalization_min_region_count != null) ? "--colocalization-min-region-count ${params.colocalization_min_region_count}" : '',
        ].join(' ').trim()
    }

    withName: PIXELATOR_REPORT {
        ext.when = { !params.skip_report }
    }


    withName: CUSTOM_DUMPSOFTWAREVERSIONS {
        publishDir = [
            path: { "${params.outdir}/pipeline_info" },
            mode: params.publish_dir_mode,
            pattern: '*_versions.yml'
        ]
    }
}
